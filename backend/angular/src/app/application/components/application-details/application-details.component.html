<app-nav></app-nav>
<div class="workflow-test-container">
  <div class="main-header">
    <div>
      <button class="back-button" (click)="goBack()">
        <i class="bi bi-arrow-left"></i> Back to Applications
      </button>
      <h1 class="workflow-title">Agricultural Record Application</h1>
    </div>
  </div>

  <!-- Status and Messages -->
  <div class="status-container">
    <div *ngIf="isLoading" class="loading-indicator">
      <div class="spinner"></div>
      <p>{{ statusMessage }}</p>
    </div>
    <div *ngIf="errorMessage" class="error-message alert alert-danger">
      <i class="bi bi-exclamation-circle me-2"></i>
      <p>{{ errorMessage }}</p>
    </div>
    <div *ngIf="statusMessage && !isLoading" class="status-message alert alert-info">
      <i class="bi bi-info-circle me-2"></i>
      <p>{{ statusMessage }}</p>
    </div>
  </div>

  <!-- Application Info -->
  <div *ngIf="application" class="application-info card">
    <div class="card-header">
      <div class="card-title">
        <h2>{{ application.title }}</h2>
        <span class="id-display">#{{ application.applicationNumber }}</span>
      </div>
      <span class="status-badge" [ngClass]="getStatusClass(application.status)">
        {{ getStatusDisplayValue(application.status) }}
      </span>
    </div>
    <div class="card-body">
      <div class="application-details">
        <div class="detail-row">
          <span class="label">Application ID:</span>
          <span class="value">{{ application.id }}</span>
        </div>
        <div class="detail-row">
          <span class="label">Application Number:</span>
          <span class="value">{{ application.applicationNumber }}</span>
        </div>
        <div class="detail-row">
          <span class="label">Applicant:</span>
          <span class="value">{{ application.applicant.name }}</span>
        </div>
        <div class="detail-row">
          <span class="label">National ID:</span>
          <span class="value">{{ application.applicant.nationalId }}</span>
        </div>
        <div class="detail-row">
          <span class="label">Email:</span>
          <span class="value">{{ application.applicant.email }}</span>
        </div>
        <div class="detail-row">
          <span class="label">Phone:</span>
          <span class="value">{{ application.applicant.phone }}</span>
        </div>
        <div class="detail-row">
          <span class="label">Address:</span>
          <span class="value">{{ application.applicant.address }}</span>
        </div>
        <div class="detail-row">
          <span class="label">Farm Location:</span>
          <span class="value">{{ application.farmLocation.address }}</span>
        </div>
        <div class="detail-row">
          <span class="label">Farm Size:</span>
          <span class="value">{{ application.farmLocation.size }} hectares</span>
        </div>
        <div class="detail-row">
          <span class="label">Region:</span>
          <span class="value">{{ application.farmLocation.region }}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Reviewer Actions Section -->
  <div *ngIf="application && canReview()" class="review-actions-section">
    <div class="section">
      <h3 class="section-heading">Review Actions</h3>
      <p class="review-message">This application requires your review as {{ currentUser?.role }}</p>
      <div class="review-buttons">
        <button class="btn btn-success" (click)="approveApplication()">
          <i class="bi bi-check-circle"></i> Approve
        </button>
        <button class="btn btn-warning" (click)="returnForRevision()">
          <i class="bi bi-arrow-counterclockwise"></i> Return for Revision
        </button>
        <button class="btn btn-danger" (click)="rejectApplication()">
          <i class="bi bi-x-circle"></i> Reject Application
        </button>
      </div>
    </div>
  </div>

  <!-- Application Process Section -->
  <div *ngIf="application" class="section">
    <h2 class="section-heading">
      <i class="bi bi-list-check me-2"></i>
      Application Process
    </h2>
    <div class="workflow-timeline">
      <!-- Step 1: Submit Application -->
      <div class="timeline-step" [ngClass]="{'completed': currentStep > 0, 'current': currentStep === 0}">
        <div class="step-number">1</div>
        <div class="step-content">
          <div class="step-title">Submit Application</div>
          <div class="step-status" *ngIf="currentStep > 0">
            <span class="status-badge completed">
              <i class="bi bi-check-circle-fill"></i> Completed
            </span>
          </div>
          <div class="step-status" *ngIf="currentStep === 0">
            <span class="status-badge current">
              <i class="bi bi-arrow-right-circle-fill"></i> Current
            </span>
          </div>
        </div>
      </div>

      <!-- Step 2: LP Specialist Review -->
      <div class="timeline-step" [ngClass]="{'completed': currentStep > 1, 'current': currentStep === 1}">
        <div class="step-number">2</div>
        <div class="step-content">
          <div class="step-title">LP Specialist Review</div>
          <div class="step-status" *ngIf="currentStep > 1">
            <span class="status-badge completed">
              <i class="bi bi-check-circle-fill"></i> Completed
            </span>
          </div>
          <div class="step-status" *ngIf="currentStep === 1">
            <span class="status-badge current">
              <i class="bi bi-arrow-right-circle-fill"></i> Current
            </span>
          </div>
        </div>
      </div>

      <!-- Step 3: LP Specialist Decision -->
      <div class="timeline-step" [ngClass]="{'completed': currentStep > 2, 'current': currentStep === 2}">
        <div class="step-number">3</div>
        <div class="step-content">
          <div class="step-title">LP Specialist Decision</div>
          <div class="step-status" *ngIf="currentStep > 2">
            <span class="status-badge completed">
              <i class="bi bi-check-circle-fill"></i> Completed
            </span>
          </div>
          <div class="step-status" *ngIf="currentStep === 2">
            <span class="status-badge current">
              <i class="bi bi-arrow-right-circle-fill"></i> Current
            </span>
          </div>
        </div>
      </div>

      <!-- Step 4: Agriculture Manager Review -->
      <div class="timeline-step" [ngClass]="{'completed': currentStep > 3, 'current': currentStep === 3}">
        <div class="step-number">4</div>
        <div class="step-content">
          <div class="step-title">Agriculture Manager Review</div>
          <div class="step-status" *ngIf="currentStep > 3">
            <span class="status-badge completed">
              <i class="bi bi-check-circle-fill"></i> Completed
            </span>
          </div>
          <div class="step-status" *ngIf="currentStep === 3">
            <span class="status-badge current">
              <i class="bi bi-arrow-right-circle-fill"></i> Current
            </span>
          </div>
        </div>
      </div>

      <!-- Step 5: Agriculture Manager Decision -->
      <div class="timeline-step" [ngClass]="{'completed': currentStep > 4, 'current': currentStep === 4}">
        <div class="step-number">5</div>
        <div class="step-content">
          <div class="step-title">Agriculture Manager Decision</div>
          <div class="step-status" *ngIf="currentStep > 4">
            <span class="status-badge completed">
              <i class="bi bi-check-circle-fill"></i> Completed
            </span>
          </div>
          <div class="step-status" *ngIf="currentStep === 4">
            <span class="status-badge current">
              <i class="bi bi-arrow-right-circle-fill"></i> Current
            </span>
          </div>
        </div>
      </div>

      <!-- Step 6: COO Review -->
      <div class="timeline-step" [ngClass]="{'completed': currentStep > 5, 'current': currentStep === 5}">
        <div class="step-number">6</div>
        <div class="step-content">
          <div class="step-title">COO Review</div>
          <div class="step-status" *ngIf="currentStep > 5">
            <span class="status-badge completed">
              <i class="bi bi-check-circle-fill"></i> Completed
            </span>
          </div>
          <div class="step-status" *ngIf="currentStep === 5">
            <span class="status-badge current">
              <i class="bi bi-arrow-right-circle-fill"></i> Current
            </span>
          </div>
        </div>
      </div>

      <!-- Step 7: Final Decision -->
      <div class="timeline-step" [ngClass]="{'completed': currentStep > 6, 'current': currentStep === 6}">
        <div class="step-number">7</div>
        <div class="step-content">
          <div class="step-title">Final Decision</div>
          <div class="step-status" *ngIf="currentStep > 6">
            <span class="status-badge completed">
              <i class="bi bi-check-circle-fill"></i> Completed
            </span>
          </div>
          <div class="step-status" *ngIf="currentStep === 6">
            <span class="status-badge current">
              <i class="bi bi-arrow-right-circle-fill"></i> Current
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Reviews Section -->
  <div *ngIf="reviews && reviews.length > 0" class="section">
    <h2 class="section-heading">
      <i class="bi bi-chat-left-text me-2"></i>
      Review History
    </h2>
    <div class="reviews-container">
      <div *ngFor="let review of reviews" class="review-card">
        <div class="review-header">
          <div class="reviewer-info">
            <strong>{{ review.reviewerName }}</strong>
            <span class="reviewer-role">{{ review.reviewerId === '101' ? 'LP Specialist' : review.reviewerId === '102' ? 'Agriculture Manager' : 'COO' }}</span>
          </div>
          <div class="review-date">
            {{ review.reviewDate | date:'MMM d, y h:mm a' }}
          </div>
        </div>
        <div class="review-decision"
             [ngClass]="{'decision-approve': review.decision === 'APPROVE',
                         'decision-reject': review.decision === 'REJECT',
                         'decision-change': review.decision === 'REQUEST_CHANGES'}">
          {{ review.decision === 'APPROVE' ? 'Approved' :
             review.decision === 'REJECT' ? 'Rejected' : 'Requested Changes' }}
        </div>
        <div class="review-comments">
          {{ review.comment }}
        </div>
      </div>
    </div>
  </div>
</div>
